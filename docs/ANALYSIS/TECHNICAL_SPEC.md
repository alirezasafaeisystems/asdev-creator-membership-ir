# TECHNICAL_SPEC — استاندارد فنی، ماژولار، Local‑First (ضدتحریم)
این سند «جمع‌بندی اجرایی» است: یعنی اگر فقط همین را بخوانی، بتوانی تصمیم‌های فنی را ببندی و بعد وارد داک‌های جزئی‌تر ریپو شوی.

## اهداف محصول (Product Goals)
- پلتفرم عضویت و اشتراک برای کریتورهای ایرانی با:
  - پلن‌های عضویت (ماهانه/سالانه)، کد تخفیف، Trial (اختیاری)، تمدید، لغو، انقضا.
  - محتوای قفل‌شده (مقاله/فایل/ویدیو) و تجربه‌ی کاربری قابل اتکا حتی با اینترنت ضعیف.
  - داشبورد کریتور: پلن‌ها، اعضا، درآمد، گزارش‌ها، درخواست تسویه.
  - داشبورد کاربر: اشتراک‌ها، پرداخت‌ها، دانلودها، پشتیبانی.
  - پنل ادمین: نظارت، ضدتقلب، محتوای گزارش‌شده، تراکنش‌های مشکوک، مدیریت کریتورها.

## قیود ایران (Local‑First Constraints)
- **هیچ وابستگی runtime به دامنه‌های خارجی** (CDN، فونت گوگل، اسکریپت‌ها، آنالیتیکس خارجی…) وجود ندارد.
- پرداخت از طریق درگاه‌های ایرانی (زرین‌پال / IDPay / …) با طراحی «Provider Interface» تا قابل تعویض باشد.
- ارسال پیامک از طریق Provider داخلی (SMS.ir / Kavenegar / …) با همان الگوی Provider Interface.
- ذخیره فایل‌ها: یا «روی دیسک + Nginx/X-Accel» یا «MinIO self-hosted» (بدون AWS S3).
- برای سئو و عملکرد: SSR/SSG + کش + استاتیک‌سازی صفحات عمومی.

## معماری پیشنهادی (Modular Monolith با مرزبندی Domain)
> این پروژه از نظر پیچیدگی‌های مالی/امنیتی بهتر است با **Modular Monolith** شروع شود (ماژولار ولی یک دیپلوی) و بعداً به سرویس‌ها شکسته شود.

### ماژول‌ها (Domains)
- Identity & Access: Auth، Session، RBAC، Audit Log
- Creator: پروفایل کریتور، تنظیمات، KYC سبک (اختیاری)
- Plans & Pricing: پلن‌ها، مزایا، قیمت‌گذاری، کوپن
- Subscription: وضعیت‌ها، چرخه عمر، تمدید، انقضا، لغو، Grace Period
- Payments: درگاه‌ها، callback/webhook، تراکنش، reconciliation
- Content: آپلود/قفل محتوا/دانلود امن/Tokenized URLs
- Members: لیست اعضا، فیلتر، tags، پیام‌های سیستم (اختیاری)
- Payouts: درخواست تسویه، وضعیت، گزارش
- Admin: moderation، risk، support tools
- Observability: logs/metrics/traces، alerting rules

## استانداردهای کلیدی
### 1) قراردادهای امنیت
- JWT کوتاه‌عمر + Refresh Token، ذخیره امن (HttpOnly cookie برای وب).
- Rate limit برای auth و callbackهای پرداخت.
- Audit Log برای رخدادهای حساس: login، تغییر پلن، تسویه، تغییر روش پرداخت.
- Content access: کنترل دسترسی در سرور (نه صرفاً در UI).

### 2) قراردادهای مالی
- وضعیت تراکنش و اشتراک باید «Idempotent» باشد: callback دوبار آمد نباید دوبار عضو کند.
- هر پرداخت یک `payment_intent` داخلی دارد (شناسه داخلی) که به درگاه نگاشت می‌شود.
- درگاه‌ها «قابل تعویض» هستند: `GatewayAdapter` interface.

### 3) تجربه Local‑First
- فونت‌ها self-hosted
- بدون fetch به دامنه خارجی
- برای صفحات عمومی: SSG/ISR
- برای داشبورد: CSR با API داخلی
- برای قطع اینترنت: صفحات خطا/آفلاین و تجربه پایدار

## خروجی‌های وابسته (این بسته)
- نقشه API: `docs/ANALYSIS/API_MAP.md`
- طرح دیتابیس: `docs/ANALYSIS/DATABASE_SCHEMA.md`
- وایرفریم‌ها: `docs/WIREFRAMES/*`
- Roadmap: `docs/ANALYSIS/ROADMAP.md`
