// 02-membership/prisma/schema.membership.prisma
// snippet — داخل schema.prisma اصلی paste کنید.

enum UserRole {
  MEMBER
  CREATOR_OWNER
  PLATFORM_ADMIN
  SUPPORT
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  CANCELED
  EXPIRED
}

enum BillingPeriod {
  MONTHLY
  YEARLY
  ONE_TIME
}

enum PaymentStatus {
  INITIATED
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
}

enum PaymentProvider {
  IDPAY
  ZARINPAL
  PAYPING
  MOCK
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         UserRole @default(MEMBER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions      Session[]
  creators      Creator[] @relation("CreatorOwners")
  subscriptions Subscription[]
  payments      Payment[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Creator {
  id      String @id @default(cuid())
  slug    String @unique
  name    String
  bio     String?
  ownerId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner    User @relation("CreatorOwners", fields: [ownerId], references: [id], onDelete: Restrict)
  plans    Plan[]
  contents ContentItem[]

  @@index([ownerId])
}

model Plan {
  id        String @id @default(cuid())
  creatorId String

  title       String
  description String?
  priceToman  Int
  period      BillingPeriod @default(MONTHLY)
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creator       Creator @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]

  @@index([creatorId, isActive])
}

model Subscription {
  id     String @id @default(cuid())
  userId String
  planId String

  status SubscriptionStatus @default(PENDING)

  startedAt        DateTime?
  currentPeriodEnd DateTime?
  canceledAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan   Plan @relation(fields: [planId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@unique([userId, planId])
  @@index([status, currentPeriodEnd])
}

model Payment {
  id             String @id @default(cuid())
  userId         String
  subscriptionId String?
  amountToman    Int

  provider PaymentProvider @default(MOCK)
  status   PaymentStatus   @default(INITIATED)

  providerAuthority   String?
  providerRef         String?
  callbackReceivedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription  Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  events        PaymentEvent[]
  webhookReceipts WebhookReceipt[]

  @@index([status, createdAt])
  @@index([provider, providerAuthority])
}

model PaymentEvent {
  id        String @id @default(cuid())
  paymentId String
  kind      String
  payload   Json?
  createdAt DateTime @default(now())

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId, createdAt])
}

model WebhookReceipt {
  id         String @id @default(cuid())
  provider   PaymentProvider
  externalId String
  receivedAt DateTime @default(now())
  payload    Json?

  paymentId String?
  payment   Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  @@unique([provider, externalId])
}

model ContentItem {
  id        String @id @default(cuid())
  creatorId String

  title       String
  description String?
  isPublished Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creator     Creator @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  assets      Asset[]
  accessRules ContentAccessRule[]

  @@index([creatorId, isPublished])
}

model Asset {
  id        String @id @default(cuid())
  contentId String

  storageKey String
  fileName   String
  mimeType   String?
  sizeBytes  Int?

  createdAt DateTime @default(now())

  content ContentItem @relation(fields: [contentId], references: [id], onDelete: Cascade)
}

model ContentAccessRule {
  id        String @id @default(cuid())
  contentId String
  planId    String

  content ContentItem @relation(fields: [contentId], references: [id], onDelete: Cascade)
  plan    Plan        @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([contentId, planId])
}

model DownloadToken {
  id        String @id @default(cuid())
  token     String @unique
  assetId   String
  userId    String
  expiresAt DateTime
  revokedAt DateTime?

  createdAt DateTime @default(now())

  @@index([assetId, userId])
  @@index([expiresAt])
}
